#!/usr/bin/env node
/**
 * Build varieties.json from extracted Excel data.
 *
 * Reads: tmp/varieties_from_excel.json
 * Writes: src/data/varieties.json
 *
 * Transforms raw Excel variety data into CreateVarietyInput format (no IDs).
 * IDs are generated by the store during import using content-based deduplication.
 *
 * Usage:
 *   node src/data/build-varieties.js
 */

const fs = require('fs');
const path = require('path');
const { normalizeCropName } = require('./crop-name-mapping');

// Paths
const inputPath = path.join(__dirname, '..', '..', 'tmp', 'varieties_from_excel.json');
const outputPath = path.join(__dirname, 'varieties.json');

// Generate a content key for deduplication (matches variety.ts getVarietyContentKey)
function getContentKey(crop, name, supplier) {
  return `${crop}|${name}|${supplier}`.toLowerCase().trim();
}

// Read input
console.log('Reading extracted variety data...');
if (!fs.existsSync(inputPath)) {
  console.error(`Input file not found: ${inputPath}`);
  console.error('Run: python scripts/extract-varieties.py');
  process.exit(1);
}

const rawData = JSON.parse(fs.readFileSync(inputPath, 'utf8'));
const rawVarieties = rawData.varieties || [];

console.log(`Processing ${rawVarieties.length} varieties...`);

// Transform to CreateVarietyInput format (no id field - store generates IDs)
const varieties = [];
const seenKeys = new Set();

for (const raw of rawVarieties) {
  // Skip varieties without required fields
  if (!raw.crop && !raw.name) continue;

  const crop = normalizeCropName(raw.crop || '');
  const name = (raw.name || '').trim();
  const supplier = (raw.supplier || '').trim();

  // CreateVarietyInput format - no id field
  const variety = {
    crop,
    name,
    supplier,
    organic: Boolean(raw.organic),
    pelleted: Boolean(raw.pelleted),
  };

  // Optional fields
  if (raw.pelletedApproved) variety.pelletedApproved = true;
  if (raw.dtm && typeof raw.dtm === 'number') variety.dtm = raw.dtm;
  if (raw.website) variety.website = raw.website;
  if (raw.alreadyOwn) variety.alreadyOwn = true;
  if (raw.subCategory) variety.subCategory = raw.subCategory;

  // Handle duplicates (same crop/name/supplier)
  const contentKey = getContentKey(crop, name, supplier);
  if (seenKeys.has(contentKey)) {
    console.warn(`Duplicate variety: ${crop} - ${name} (${supplier})`);
    continue;
  }
  seenKeys.add(contentKey);

  varieties.push(variety);
}

console.log(`Processed ${varieties.length} unique varieties`);

// Sort by crop, then name
varieties.sort((a, b) => {
  const cropCmp = a.crop.localeCompare(b.crop);
  if (cropCmp !== 0) return cropCmp;
  return a.name.localeCompare(b.name);
});

// Output structure
const output = {
  _generated: new Date().toISOString(),
  _source: 'tmp/varieties_from_excel.json',
  varieties: varieties,
};

// Write output
fs.writeFileSync(outputPath, JSON.stringify(output, null, 2) + '\n');
console.log(`Wrote ${outputPath}`);

// Stats
const crops = new Set(varieties.map(v => v.crop));
const suppliers = new Set(varieties.map(v => v.supplier).filter(Boolean));
const organicCount = varieties.filter(v => v.organic).length;

console.log('\n--- Statistics ---');
console.log(`Total varieties: ${varieties.length}`);
console.log(`Unique crops: ${crops.size}`);
console.log(`Unique suppliers: ${suppliers.size}`);
console.log(`Organic varieties: ${organicCount}`);
