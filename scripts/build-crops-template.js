#!/usr/bin/env node
/**
 * Build crops-template.json from the Excel extract.
 *
 * Reads tmp/crops_from_excel.json (generated by extract-crops.py)
 * and outputs src/data/crops-template.json with unique crops and their colors.
 *
 * For each unique crop name, takes the first occurrence's colors.
 * Determines appropriate text color based on background luminance.
 */

const fs = require('fs');
const path = require('path');

// Default color for crops without Excel colors
const DEFAULT_BG = '#78909c';
const DEFAULT_TEXT = '#ffffff';

/**
 * Calculate relative luminance of a hex color.
 * Used to determine if text should be light or dark.
 * @see https://www.w3.org/TR/WCAG20/#relativeluminancedef
 */
function getLuminance(hex) {
  // Remove # if present
  const rgb = hex.replace('#', '');
  const r = parseInt(rgb.substring(0, 2), 16) / 255;
  const g = parseInt(rgb.substring(2, 4), 16) / 255;
  const b = parseInt(rgb.substring(4, 6), 16) / 255;

  // Apply gamma correction
  const rLinear = r <= 0.03928 ? r / 12.92 : Math.pow((r + 0.055) / 1.055, 2.4);
  const gLinear = g <= 0.03928 ? g / 12.92 : Math.pow((g + 0.055) / 1.055, 2.4);
  const bLinear = b <= 0.03928 ? b / 12.92 : Math.pow((b + 0.055) / 1.055, 2.4);

  return 0.2126 * rLinear + 0.7152 * gLinear + 0.0722 * bLinear;
}

/**
 * Get appropriate text color (black or white) based on background color.
 */
function getTextColorForBackground(bgColor) {
  if (!bgColor) return DEFAULT_TEXT;

  const luminance = getLuminance(bgColor);
  // Use white text for dark backgrounds, black for light
  return luminance > 0.4 ? '#000000' : '#ffffff';
}

/**
 * Generate a deterministic crop ID from the name.
 */
function getCropId(name) {
  return `crop_${name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')}`;
}

// Read the Excel extract
const inputPath = path.join(__dirname, '..', 'tmp', 'crops_from_excel.json');
if (!fs.existsSync(inputPath)) {
  console.error(`Error: ${inputPath} not found. Run extract-crops.py first.`);
  process.exit(1);
}

const rawData = JSON.parse(fs.readFileSync(inputPath, 'utf8'));
const rawCrops = rawData.crops;

console.log(`Read ${rawCrops.length} raw crop entries`);

// Collect all colors for each crop, then pick the most common
const cropColorCounts = new Map(); // crop -> Map<color, count>
for (const c of rawCrops) {
  const name = c.Crop?.trim(); // Normalize: trim whitespace
  if (!name || !c.bgColor) continue;

  if (!cropColorCounts.has(name)) {
    cropColorCounts.set(name, new Map());
  }
  const colorMap = cropColorCounts.get(name);
  colorMap.set(c.bgColor, (colorMap.get(c.bgColor) || 0) + 1);
}

// Also track crops without colors (from first occurrence)
const cropMap = new Map();
for (const c of rawCrops) {
  const name = c.Crop?.trim(); // Normalize: trim whitespace
  if (!name) continue;

  // If we have color counts, use the most common color
  if (cropColorCounts.has(name)) {
    const colorMap = cropColorCounts.get(name);
    let maxCount = 0;
    let mostCommonColor = null;
    for (const [color, count] of colorMap) {
      if (count > maxCount) {
        maxCount = count;
        mostCommonColor = color;
      }
    }
    cropMap.set(name, { bgColor: mostCommonColor, textColor: null });
  } else if (!cropMap.has(name)) {
    // No colors found, use null
    cropMap.set(name, { bgColor: null, textColor: null });
  }
}

console.log(`Found ${cropMap.size} unique crops`);

// Build the crops array with proper colors
const crops = [];
let cropsWithColor = 0;
let cropsWithDefault = 0;

for (const [name, colors] of cropMap) {
  const id = getCropId(name);
  let bgColor = colors.bgColor;
  let textColor;

  if (bgColor) {
    // Ensure lowercase for consistency
    bgColor = bgColor.toLowerCase();
    // Calculate appropriate text color based on luminance
    textColor = getTextColorForBackground(bgColor);
    cropsWithColor++;
  } else {
    // Use default gray for crops without colors
    bgColor = DEFAULT_BG;
    textColor = DEFAULT_TEXT;
    cropsWithDefault++;
  }

  crops.push({
    id,
    name,
    bgColor,
    textColor,
  });
}

// Sort by name for consistent output
crops.sort((a, b) => a.name.localeCompare(b.name));

console.log(`Crops with Excel colors: ${cropsWithColor}`);
console.log(`Crops with default colors: ${cropsWithDefault}`);

// Output to src/data/crops-template.json
const outputPath = path.join(__dirname, '..', 'src', 'data', 'crops-template.json');
fs.writeFileSync(outputPath, JSON.stringify(crops, null, 2));
console.log(`\nWritten ${crops.length} crops to ${outputPath}`);

// Show color distribution
const colorCounts = new Map();
for (const crop of crops) {
  const count = colorCounts.get(crop.bgColor) || 0;
  colorCounts.set(crop.bgColor, count + 1);
}

console.log('\nColor distribution:');
for (const [color, count] of Array.from(colorCounts.entries()).sort((a, b) => b[1] - a[1])) {
  const example = crops.find(c => c.bgColor === color)?.name;
  console.log(`  ${color}: ${count} crops (e.g., ${example})`);
}

// Show sample
console.log('\nSample crops:');
for (const crop of crops.slice(0, 5)) {
  console.log(`  ${crop.name}: bg=${crop.bgColor}, text=${crop.textColor}`);
}
