<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * {
      box-sizing: border-box;
      font-family: Arial, sans-serif;
    }
    body {
      margin: 0;
      padding: 15px;
    }
    h3 {
      margin: 0 0 15px 0;
      font-size: 14px;
      color: #333;
    }
    .field {
      margin-bottom: 12px;
    }
    label {
      display: block;
      font-size: 12px;
      color: #666;
      margin-bottom: 4px;
    }
    select, input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #4285f4;
    }
    .buttons {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    button {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    button.primary {
      background: #4285f4;
      color: white;
    }
    button.primary:hover {
      background: #3367d6;
    }
    button.secondary {
      background: #f1f1f1;
      color: #333;
    }
    button.secondary:hover {
      background: #e1e1e1;
    }
    .status {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
    }
    .status.error {
      color: #d32f2f;
    }
    .status.success {
      color: #388e3c;
    }
  </style>
</head>
<body>
  <h3>Configure Column Names</h3>
  <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
    Select which columns in your sheet map to each field.
  </p>

  <div class="field">
    <label>Crop Name Column</label>
    <select id="name"></select>
  </div>

  <div class="field">
    <label>Start Date Column</label>
    <select id="start"></select>
  </div>

  <div class="field">
    <label>End Date Column</label>
    <select id="end"></select>
  </div>

  <div class="field">
    <label>Resource/Bed Column</label>
    <select id="resource"></select>
  </div>

  <div class="field">
    <label>ID Column (for tracking)</label>
    <input type="text" id="id" placeholder="_id">
  </div>

  <div class="buttons">
    <button class="secondary" onclick="google.script.host.close()">Cancel</button>
    <button class="primary" onclick="save()">Save</button>
  </div>

  <div id="status" class="status"></div>

  <script>
    let headers = [];
    let currentSettings = {};

    // Load on startup
    document.addEventListener('DOMContentLoaded', init);

    function init() {
      // Load headers and current settings in parallel
      google.script.run
        .withSuccessHandler(function(h) {
          headers = h;
          google.script.run
            .withSuccessHandler(function(settings) {
              currentSettings = settings;
              populateDropdowns();
            })
            .withFailureHandler(showError)
            .getColumnSettings();
        })
        .withFailureHandler(showError)
        .getSheetHeaders();
    }

    function populateDropdowns() {
      const fields = ['name', 'start', 'end', 'resource'];

      fields.forEach(function(field) {
        const select = document.getElementById(field);
        select.innerHTML = '<option value="">-- Select Column --</option>';

        headers.forEach(function(header) {
          const option = document.createElement('option');
          option.value = header;
          option.textContent = header;
          if (currentSettings[field] === header) {
            option.selected = true;
          }
          select.appendChild(option);
        });
      });

      // ID is a text input (since it might not exist yet)
      document.getElementById('id').value = currentSettings.id || '_id';
    }

    function save() {
      const settings = {
        name: document.getElementById('name').value,
        start: document.getElementById('start').value,
        end: document.getElementById('end').value,
        resource: document.getElementById('resource').value,
        id: document.getElementById('id').value || '_id'
      };

      // Validate
      if (!settings.name || !settings.start || !settings.end || !settings.resource) {
        showError('Please select all required columns');
        return;
      }

      setStatus('Saving...', '');

      google.script.run
        .withSuccessHandler(function() {
          setStatus('Settings saved!', 'success');
          setTimeout(function() {
            google.script.host.close();
          }, 1000);
        })
        .withFailureHandler(showError)
        .saveColumnSettings(settings);
    }

    function showError(err) {
      setStatus('Error: ' + (err.message || err), 'error');
    }

    function setStatus(msg, type) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = 'status ' + (type || '');
    }
  </script>
</body>
</html>
